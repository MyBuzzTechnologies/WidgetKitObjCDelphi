# Delphi-Swift Library Interop Tutorial

The project in this repo demonstrates a working Delphi 13 project that uses a custom created native Objective C framework that wraps the WidgetKit native swift framework so that it can be used by Delphi.

Delphi doesn't natively support importing and using Swift-only frameworks within a Delphi app.
However, it DOES support using native Objective-C frameworks and mixed Objective C+Swift frameworks (though you may need to reference and link the swift frameworks as described in the excellent Kastri project (https://github.com/DelphiWorlds/HowTo/tree/main/Solutions/AddSwiftSupport))

Instructions for how to create a wrapped Swift-only framework (natively with XCode) is below.

## Sample Project Outline

The project repo contains 2 folders:

- WidgetKitDelphi -- a Delphi 13 project that consumes (and includes) the custom framework
- WidgetKitObjC - the native XCode framework project that is consumed by the Delphi project.

Note: the project was built with XCode 26.1 and Delphi 13.0 but may work with earlier versions.

### WidgetKitDelphi

This project has a few key things to note:

- The Frameworks folder contains the actual custom framework as generated by the XCode project. This is currently the debug build (which works fine) but can be the release build of the framework, recommended before you deploy to production.

- I used the excellent [Grijjy DeployMan.exe](https://github.com/grijjy/GrijjyDeployMan) to manage the deployment of the Delphi project. This is a lot easier than manually adding all files from the framework into the project manually. The .grdeploy file is included in case you want to see how this works.

- The iOSapi.WidgetKitObjC.pas file is generated by [Octoid](https://github.com/Embarcadero/octoid) from the framework

### WidgetKitObjC

This uses the mixed-mode version of a custom framework to include Swift libraries (and code) in an Objective C framework.
This is the only configuration that will work!

If you need to rebuild the custom framework and include in the Delphi project (to replace the one from this repo):

1. Open the XCode and build it.
2. Then click Project (menu) > "Show Build Folder In Finder" to see where the framework is generated.
3. Navigate through Products > Debug-iphoneos
4. Copy the _Entire_ .framework folder into the Frameworks folder in the Delphi project to replace any existing folder. Make sure to delete the existing folder first so nothing is left behind that may confuse the project.

## How-To From Scratch Instructions

Note: the instructions below refer to XCode 26.1 and Delphi 13. If you use earlier versions of each, you should be able to do what is described but the menu options may be called something different.

## In XCode

### 1. Create an Objective C Framework project in XCode

- File menu > NEW > PROJECT
- Select "iOS" from the top platform options. DO NOT USE MULTIPLATFORM!
- Select "Framework"
- Click NEXT

- Type a Project Name. This will become the name of your framework when exported so make it relevant. _E.g. WidgetKitObjC_ (i.e. the swift library name being wrapped + ObjC)
- MOST IMPORTANT! Choose "Objective C" as the Language
- Type an Organisation Identifier. Usually this will be match the prefix you'll be using for your Delphi app, especially if you plan to use App Groups to share data etc.
- All other options can be left as default

- Click NEXT
- Choose a location for your XCode project to be stored
- Click to create the project

### 2. Add your swift library (the one you're wrapping) to the XCode project

- In the file navigator (first panel in the left pane) click the root node to see the project options
- In "General", under "Frameworks and Libraries" click the + button
- Select your framework to add it
- After adding, make sure it is set to "Do Not Embed" in the Embed column
- Make sure you set the Minimum Deployments version to match the min version supported by the Swift library you're wrapping

### 3. Add your Swift sources

This part is completely up to you, and depends on your swift library.

The concept is:

- you need to write a Swift class that "uses" the relevant Swift library functions, then exposes the result from the function. This can be a very thin wrapper (i.e. a straight 1-2-1 mapping) which may seem odd, but allows us to mark these as exposed for Objective C, which is basically what Apple hasn't done (and why we're doing this).

E.g.:

- Add a new Swift file to the project called "WidgetCenterBridge.swift"
- Fill the source as shown below:

```swift
import Foundation
import WidgetKit

@available(iOS 14.0, *)
@objcMembers
public final class WidgetCenterBridge: NSObject {

    /// Reload all timelines for all widget kinds
    public static func reloadAllTimelines() {
        #if canImport(WidgetKit)
        WidgetCenter.shared.reloadAllTimelines()
        #endif
    }

    /// Reload timelines for a specific widget kind
    public static func reloadTimelines(ofKind kind: String) {
        #if canImport(WidgetKit)
        WidgetCenter.shared.reloadTimelines(ofKind: kind)
        #endif
    }
}
```

Note that the methods here are wrapped with **canImport()** to make sure the WidgetKit library is available, and the whole class is wrapped in an **@available()** so the class isn't available to iOS versions lower than WidgetKit supports.

**Important Note**

You need to MARK the class with a **@objcMembers** decorator as shown above so that XCode automatically makes this custom swift class visible to Objective C code (needed later).

All class methods we want to make available to Objective C MUST be **public** or **open** otherwise they can't be used.

Notice how in the above code, the methods just call the equivalent methods of the WidgetKit swift library, and uses the same names and parameters. This is absolutely fine.

You can of course add other custom code, checks etc if you want to, or even write more complex custom methods to perform custom actions using the swift libraries. It's up to you.

### 4. Add an Objective C Wrapper

Once your custom Swift class is written and exposed with @objMembers and public, you need to write an Objective C class that consumes this and exposes so that Delphi can pick it up.

Again - this is a very thin wrapper class, which is correct.

- Create a new **Objective C class file** (.m)
- Create a new \*\*Objective C header file (.h) with the same name, so you have a pair

Write your class and header interface in Objective C into these files.

E.g.:

WidgetKitObjCWrapper.h

```objectivec
#import <Foundation/Foundation.h>

NS_ASSUME_NONNULL_BEGIN

API_AVAILABLE(ios(14.0))
@interface WidgetKitObjCWrapper : NSObject

+ (void)reloadAllTimelines;
+ (void)reloadTimelinesOfKind:(NSString *)kind;

@end

NS_ASSUME_NONNULL_END
```

WidgetKitObjCWrapper.m

```objectivec
#import <Foundation/Foundation.h>
#import "WidgetKitObjCWrapper.h"
#import <WidgetKitObjC/WidgetKitObjC-Swift.h>

@implementation WidgetKitObjCWrapper

+ (void)reloadAllTimelines {
    if (@available(iOS 14.0, *)) {
        [WidgetCenterBridge reloadAllTimelines];
    }
}

+ (void)reloadTimelinesOfKind:(NSString *)kind {
    if (@available(iOS 14.0, *)) {
        [WidgetCenterBridge reloadTimelinesOfKind:kind];
    }
}

@end
```

See [this document](https://developer.apple.com/documentation/swift/importing-swift-into-objective-c) for how to write interoperable code.

Tip: the main parts to include as the ...-Swift.h> import. You won't see this in your project tree, as it's auto-generated but will be the same name as your custom Swift file with -Swift suffix.

Note: Make sure to add the API_AVAILABLE() and @available() wrappings as shown above if your wrapped Swift framework needs them (same as you did in the custom Swift class file).

### 5. Make the new Objective C class visible (VERY IMPORTANT)

I missed this final point the first few times I tried to get this working. And it's so important! If you miss this step, the generated Delphi header file won't include the class you've spent time writing.

- Click on the root node of the project to see the project settings panes
- Click the .h file for your custom Objective C class
- If you don't have the right-hand pane open in XCode, expand it with the button in the top-right of the IDE
- DOUBLE-CLICK on the toolbox icon in the **Target Membership** area to edit it
- Change the visibility to **Public** (it's likely to be "Project", but this is wrong)

### 6. Add a reference to this .h file to the umbrella header file

When you first created the project there will have been a default .h file created matching the name of your framework.

Edit this file and add an #import line for your Objective C header file (the one you just made public).

E.g. #import <WidgetKitObjC/WidgetKitObjCWrapper.h>

Do this at the bottom.

### 6. Build and see what happens!

Build it. Any errors, fix them.

Once successful, find the built framework so you can pull it into your Delphi project.

**Product** menu > **Show Build Folder In Finder**

Navigate through Products > Debug-iphoneos to get to the .framework folder.

**NOTE:** you will need this folder in its entirety, so make sure you copy the entire thing when instructed in the next section of these instructions.

## In Delphi

Now, how do you actually use this custom framework in Delphi?

Fundamentally it follows these steps:

1. Copy the custom framework into your SDK folder so Octoid can import it

2. Use [Octoid](https://github.com/Embarcadero/octoid) to generate a header file for your custom framework

3. Create your project, which involves some project and linker config, importing the custom framework into the Deployment for the project, importing the newly generated header file from step 2 and voila.

I'll expand on all these below:
